const SYSTEM_PROMPT = `
–¢—ã ‚Äî AI Requirements & QA Analyst, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞ AI Requirements Generator (MVP).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –≤—ã—è–≤–ª—è—Ç—å –Ω–µ—è—Å–Ω–æ—Å—Ç–∏, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å Acceptance Criteria, —Ç–µ—Å—Ç-–∫–µ–π—Å—ã, —Ä–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:

–æ–ø–∏—Å–∞–Ω–∏—è —Ñ–∏—á–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,

–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (—Ñ–∞–π–ª—ã, —Å—Å—ã–ª–∫–∏, —Ç–µ–∫—Å—Ç),

–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

–¢—ã —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–µ—à—å –ø—Ä–∞–≤–∏–ª–∞ –Ω–∏–∂–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö.

üìå 1. –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–ª–∏ –≤ KB.

–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ä–æ–ª–∏, —Å—Ç–∞—Ç—É—Å—ã, —Å—Ü–µ–Ω–∞—Ä–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Å—É—â–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ë–î, API, –æ—á–µ—Ä–µ–¥–∏, —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞).

–í—Å–µ –≤—ã–≤–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ñ–æ—Ä–º–∞–ª–∏–∑—É–µ–º—ã–º–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–º–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å KB (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å).

üìå 2. –†–∞–±–æ—Ç–∞ —Å Knowledge Base

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –¥–æ 5 —Ñ–∞–π–ª–æ–≤ (PDF, DOCX, TXT, XLSX) –∏ –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫.

–ï—Å–ª–∏ KB –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

–¢—ã –æ–±—è–∑–∞–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:
—Ä–æ–ª–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –¥–æ–º–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É, —Å—Ç–∞—Ç—É—Å—ã, –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞.

–ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.

–ï—Å–ª–∏ KB –Ω–µ—Ç:

–ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–ª—É—à–∫—É:

"Knowledge base –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞. –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ —Ñ–∏—á–∏."

üìå 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª —Å–µ–∫—Ü–∏–∏ ‚Äî –Ω–µ –≤—ã–≤–æ–¥–∏ –∏—Ö.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

—è–∑—ã–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: RU / EN

–≤–∫–ª—é—á–∞—Ç—å/–Ω–µ –≤–∫–ª—é—á–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

–≤–∫–ª—é—á–∞—Ç—å/–Ω–µ –≤–∫–ª—é—á–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

–≤–∫–ª—é—á–∞—Ç—å/–Ω–µ –≤–∫–ª—é—á–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

–≤–∫–ª—é—á–∞—Ç—å/–Ω–µ –≤–∫–ª—é—á–∞—Ç—å out-of-scope

–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å/–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å KB

üìå 4. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É)
–í—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤ –≤—ã–≤–æ–¥–∏ –∫–∞–∫ markdown-–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è 3:

### –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
### –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
### –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è
### –†–∏—Å–∫–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
### Acceptance Criteria
### –¢–µ—Å—Ç-–∫–µ–π—Å—ã –≤ —Ç–∞–±–ª–∏—Ü–µ Markdown
### –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º
### Out of Scope

ID —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ (—Å—Ç–æ–ª–±–µ—Ü ID: TC1, TC2, ...) –≤—ã–≤–æ–¥–∏ –∂–∏—Ä–Ω—ã–º: **TC1**, **TC2** –∏ —Ç.–¥.

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤—ã–≤–æ–¥–∏ –±–ª–æ–∫–∏ –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ:

–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–¥–æ 10)
‚ÄÉ–ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Üí ‚Äú–£—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç ‚Äî –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.‚Äù

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–µ–∑ –Ω–∏—Ö –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)

–†–∏—Å–∫–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

Acceptance Criteria (Given / When / Then)

–¢–µ—Å—Ç-–∫–µ–π—Å—ã –≤ —Ç–∞–±–ª–∏—Ü–µ Markdown

–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º (Unit / Integration / E2E)

Out of Scope (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)

üìå 5. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Ç–∞–∫:

‚Äú–ß—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑, –Ω—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è. –í–æ–ø—Ä–æ—Å—ã –Ω–∏–∂–µ:‚Äù

–°—Ñ–æ—Ä–º–∏—Ä—É–π –¥–æ 10 –≤–æ–ø—Ä–æ—Å–æ–≤.
–î—Ä—É–≥–∏–µ –±–ª–æ–∫–∏ –Ω–µ –≤—ã–≤–æ–¥–∏.

üìå 6. –°—Ç–∏–ª—å

–§–æ—Ä–º–∞–ª—å–Ω–æ

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ

–ë–µ–∑ –≤–æ–¥—ã

–ë–µ–∑ UI-–æ–ø–∏—Å–∞–Ω–∏–π

–ë–µ–∑ –¥–æ–≥–∞–¥–æ–∫

–°—Ç—Ä–æ–≥–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å KB, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å

üìå 7. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:

–æ–ø–∏—Å—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã,

—Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ë–î, API, –æ—á–µ—Ä–µ–¥–µ–π, —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤,

–ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è,

–º–µ–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö.

üìå 8. –Ø–∑—ã–∫

–ò—Å–ø–æ–ª—å–∑—É–π —è–∑—ã–∫, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
–ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ —Ñ–∏—á–∏.

üìå 9. –°—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–ù–µ –∏–∑–º–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–æ–≤, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —Å–µ–∫—Ü–∏–∏.

üìå 10. –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü (Markdown strict)

–ß—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö:

üîí –ñ—ë—Å—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü—ã:
| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –í—Ö–æ–¥ | –®–∞–≥–∏ | –û–† | –¢–∏–ø |
|----|----------|------|------|----|-----|

üîí –ü—Ä–∞–≤–∏–ª–∞:

–ú–µ–∂–¥—É —Å—Ç–æ–ª–±—Ü–∞–º–∏ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ –∏ –¥–æ |.

–ù–∏–∫–∞–∫–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–π–∫–∏.

–ù–∏–∫–∞–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ | –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ (–∑–∞–º–µ–Ω—è—Ç—å –Ω–∞ /).

–ù–∏–∫–∞–∫–∏—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã.

–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º –∏ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–º.

üìå 11. –®–∞–≥–∏ —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å—Ç–æ–ª–±–∏–∫ —á–µ—Ä–µ–∑ <br>

Markdown –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ —è—á–µ–π–∫–∞—Ö, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTML-—Ç–µ–≥ <br>.

–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
1) –î–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–≤–æ–µ<br>2) –î–µ–π—Å—Ç–≤–∏–µ –≤—Ç–æ—Ä–æ–µ<br>3) –î–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ—Ç—å–µ

–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:
| TC1 | –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ | –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç | 1) –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç<br>2) –ù–∞–∂–∞—Ç—å "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å"<br>3) –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å | –ü—Ä–æ–µ–∫—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω | Positive |

–ü—Ä–∞–≤–∏–ª–∞:

–¢–æ–ª—å–∫–æ <br> –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫.

–ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –ø–µ—Ä–µ–¥ –∏–ª–∏ –ø–æ—Å–ª–µ <br>.

–í—Å—è —è—á–µ–π–∫–∞ ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞.

–ï—Å–ª–∏ —à–∞–≥–∏ –¥–ª–∏–Ω–Ω—ã–µ ‚Äî —Å–æ–∫—Ä–∞—â–∞–π, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–º—ã—Å–ª.

üìå 12. –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞

–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –∏–ª–∏ –ª–æ–º–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É:

—É–ø—Ä–æ—â–∞–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏,

—Å–æ–∫—Ä–∞—â–∞–π –¥–ª–∏–Ω–Ω—ã–µ —á–∞—Å—Ç–∏,

–∏–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π,

–æ—Å—Ç–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Å–º—ã—Å–ª.
`.trim();


exports.handler = async (event) => {
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      body: "Method Not Allowed",
    };
  }

  const airtableToken = process.env.AIRTABLE_TOKEN;
  const baseId = process.env.AIRTABLE_BASE_ID;
  const requestsTable = process.env.AIRTABLE_REQUESTS_TABLE || "Requests";
  const openaiApiKey = process.env.OPENAI_API_KEY;
  const openaiModel = process.env.OPENAI_MODEL || "gpt-4.1-mini";

  let requestId = null;

  try {
    const body = JSON.parse(event.body || "{}");

    const {
        feature,
        extraInfo = "",
        kbLinks = [],
        kbFiles = [],
        language = "RU",
        include = {},
        parentRequestId = null,
    } = body;


    // 1. —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ Airtable —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º in_progress
    const fields = {
      "Feature Description": feature || "",
      "KB Links": kbLinks.join("\n"),
      "Language": language,
      "Include Questions": !!include.questions,
      "Include Acceptance Criteria": !!include.acceptanceCriteria,
      "Include Test Cases": !!include.testCases,
      "Include Negative Scenarios": !!include.negativeScenarios,
      "Include Out Of Scope": !!include.outOfScope,
      "Use Knowledge Base": !!include.useKnowledgeBase,
      "Status": "in_progress",
    };


    const createRes = await fetch(
      `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(
        requestsTable
      )}`,
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ fields }),
      }
    );

    const created = await createRes.json();

    if (!createRes.ok) {
        console.error("Airtable create error:", created);
    return {
        statusCode: 500,
        body: JSON.stringify({
        error: "Airtable create failed",
        airtable: created   // <- —Ç—É—Ç –±—É–¥–µ—Ç —Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Airtable
        }),
    };
    }


    requestId = created.id;

    // 2. –≤—ã–∑—ã–≤–∞–µ–º OpenAI
    const userPayload = {
        feature,
        extraInfo,
        kbLinks,
        kbFiles,
        language,
        include,
        parentRequestId,
    };


    const openaiRes = await fetch(
      "https://api.openai.com/v1/chat/completions",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${openaiApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: openaiModel,
          messages: [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "user", content: JSON.stringify(userPayload) },
          ],
        }),
      }
    );

    const openaiData = await openaiRes.json();

    if (!openaiRes.ok) {
      console.error("OpenAI error:", openaiData);
      // –ø–æ–º–µ—á–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫–∞–∫ failed
      await markRequestFailed(baseId, requestsTable, airtableToken, requestId);
      return {
        statusCode: 500,
        body: JSON.stringify({ error: "OpenAI request failed" }),
      };
    }

    const markdown =
      openaiData.choices?.[0]?.message?.content?.trim() ||
      "–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.";

    // 3. –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ Airtable —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    await fetch(
      `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(
        requestsTable
      )}/${requestId}`,
      {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          fields: {
            "Result Markdown": markdown,
            "Status": "done",
          },
        }),
      }
    );

    // 4. –æ—Ç–¥–∞—ë–º –æ—Ç–≤–µ—Ç —Ñ—Ä–æ–Ω—Ç—É
    return {
      statusCode: 200,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId,
        result: markdown,
      }),
    };
  } catch (err) {
    console.error("generate handler error:", err);

    if (requestId) {
      try {
        await markRequestFailed(
          process.env.AIRTABLE_BASE_ID,
          process.env.AIRTABLE_REQUESTS_TABLE || "Requests",
          process.env.AIRTABLE_TOKEN,
          requestId
        );
      } catch (e) {
        console.error("failed to mark request as failed in Airtable:", e);
      }
    }

    return {
      statusCode: 500,
      body: JSON.stringify({ error: "Server error" }),
    };
  }
};

async function markRequestFailed(baseId, tableName, token, recordId) {
  await fetch(
    `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(
      tableName
    )}/${recordId}`,
    {
      method: "PATCH",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fields: {
          Status: "failed",
        },
      }),
    }
  );
}
